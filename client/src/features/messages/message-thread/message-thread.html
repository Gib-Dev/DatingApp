<div class="flex flex-col h-[calc(100vh-4rem)]">
  <!-- Header -->
  <div class="bg-base-200 px-4 py-3 border-b">
    <div class="container mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a routerLink="/messages" class="btn btn-ghost btn-sm btn-circle">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </a>
        <h2 class="text-xl font-bold">{{ recipientName() || 'Chat' }}</h2>
      </div>
    </div>
  </div>

  <!-- Loading -->
  @if (loading()) {
    <div class="flex-1 flex items-center justify-center">
      <span class="loading loading-spinner loading-lg"></span>
    </div>
  }

  <!-- Messages -->
  @if (!loading()) {
    <div id="chatContainer" class="flex-1 overflow-y-auto p-4 bg-base-300">
      <div class="container mx-auto max-w-4xl space-y-4">
        @if (messages().length === 0) {
          <div class="text-center py-20 opacity-60">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 opacity-40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
            </svg>
            <p class="text-lg">No messages yet</p>
            <p class="text-sm opacity-60">Start the conversation by sending a message</p>
          </div>
        }

        @for (message of messages(); track message.id) {
          <div class="flex" [class.justify-end]="isMyMessage(message)">
            <div class="max-w-md">
              @if (!isMyMessage(message)) {
                <div class="text-xs opacity-60 mb-1">{{ message.senderName }}</div>
              }
              <div
                class="chat-bubble px-4 py-2 rounded-2xl"
                [class.bg-primary]="isMyMessage(message)"
                [class.text-primary-content]="isMyMessage(message)"
                [class.bg-base-100]="!isMyMessage(message)"
              >
                <p class="break-words">{{ message.content }}</p>
              </div>
              <div class="text-xs opacity-50 mt-1" [class.text-right]="isMyMessage(message)">
                {{ getTimeAgo(message.dateSent) }}
                @if (message.dateRead && isMyMessage(message)) {
                  <span class="ml-2">âœ“ Read</span>
                }
              </div>
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- Input Form -->
  <div class="bg-base-200 px-4 py-3 border-t">
    <div class="container mx-auto max-w-4xl">
      <form [formGroup]="messageForm" (ngSubmit)="sendMessage()" class="flex gap-2">
        <textarea
          formControlName="content"
          placeholder="Type a message..."
          class="textarea textarea-bordered flex-1 resize-none"
          rows="1"
          (keydown.enter)="onEnterKey($event)"
        ></textarea>
        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="messageForm.invalid || sending()"
        >
          @if (sending()) {
            <span class="loading loading-spinner loading-sm"></span>
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
            Send
          }
        </button>
      </form>
      @if (messageForm.get('content')?.invalid && messageForm.get('content')?.touched) {
        <div class="text-error text-sm mt-1">
          @if (messageForm.get('content')?.errors?.['required']) {
            Message cannot be empty
          }
          @if (messageForm.get('content')?.errors?.['maxlength']) {
            Message cannot exceed 500 characters
          }
        </div>
      }
    </div>
  </div>
</div>
